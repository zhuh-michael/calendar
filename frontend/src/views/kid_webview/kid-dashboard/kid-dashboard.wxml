<view class="kid-dashboard">
  <!-- é¡¶éƒ¨æ  -->
  <view class="header">
    <view class="user-info-row">
      <!-- å¤´åƒ + æ¸¸æˆé£æ ¼è¾¹æ¡† -->
      <view class="avatar-section">
        <view class="avatar-frame {{avatarFrameClass}}">
          <image
            src="{{userInfo.avatar ? apiBaseUrl + '/' + userInfo.avatar : '../images/default-avatar.png'}}"
            mode="aspectFill"
            class="user-avatar"
          ></image>
          <!-- ç­‰çº§å¾½ç«  -->
          <view class="level-badge-mini">Lv.{{userInfo.level || 1}}</view>
        </view>
      </view>

      <!-- ç”¨æˆ·ä¿¡æ¯ -->
      <view class="user-info-col">
        <!-- ç¬¬ä¸€è¡Œï¼šåå­— + ç§°å· -->
        <view class="name-row">
          <text class="user-name">{{userInfo.nickname}}</text>
          <text class="user-title">{{userInfo.levelTitle || 'æ˜Ÿé™…è§ä¹ ç”Ÿ'}}</text>
        </view>

        <!-- ç¬¬äºŒè¡Œï¼šæ˜Ÿæ˜Ÿ + XP + è¿›åº¦ -->
        <view class="stats-row">
          <!-- æ˜Ÿæ˜Ÿ -->
          <view class="stat-item star-item">
            <text class="star-icon">â­</text>
            <text>{{userInfo.starBalance}}</text>
          </view>

          <!-- XPä¿¡æ¯ -->
          <view class="xp-info">
            <text class="xp-text">{{userInfo.exp || 0}} XP</text>
            <text class="xp-next">è·Lv.{{(userInfo.level || 1) + 1}}è¿˜éœ€ {{xpToNextLevel}} XP</text>
          </view>
        </view>

        <!-- è¿›åº¦æ¡ -->
        <view class="exp-bar-mini">
          <view class="exp-bar-fill" style="width: {{levelProgress}}%"></view>
        </view>
      </view>

      <!-- æ—¥æœŸé€‰æ‹©å™¨ -->
      <picker mode="date" value="{{selectedDate}}" bindchange="onDateChange">
        <view class="date-picker-section">
          <view class="date-picker-btn">
            <text class="date-icon">ğŸ“…</text>
          </view>
          <text class="date-label">{{formattedSelectedDate}}</text>
        </view>
      </picker>
    </view>
  </view>

  <!-- ä»Šæ—¥ä»»åŠ¡æµ -->
  <view class="task-section">
    <text class="section-title">{{isToday ? 'ğŸ“… ä»Šæ—¥ä»»åŠ¡' : selectedDateDisplay}}</text>

    <!-- åŠ è½½çŠ¶æ€ -->
    <view wx:if="{{isLoadingTasks}}" class="loading-container">
      <text class="loading-text">åŠ è½½ä¸­...</text>
    </view>

    <!-- å¾…åŠä»»åŠ¡ -->
    <view class="todo-tasks">
      <text class="subsection-title">â³ å¾…å®Œæˆ</text>
      <view wx:if="{{pendingTasks.length === 0}}" class="empty-state">
        <text class="empty-emoji">ğŸ˜Š</text>
        <text class="empty-text">ä»Šå¤©æ²¡æœ‰å¾…å®Œæˆçš„ä»»åŠ¡ï¼</text>
      </view>
      <view wx:else class="task-list">
        <view
          wx:for="{{pendingTasks}}"
          wx:key="id"
          class="task-card"
          data-id="{{item.id}}"
          bindtap="completeTask"
        >
          <view class="task-content">
            <view class="task-info">
              <text class="task-title">{{item.title}}</text>
              <view wx:if="{{item.rejectReason}}" class="task-reject-reason">
                <text class="reject-icon">âš ï¸</text>
                <text class="reject-text">ä¸Šæ¬¡è¢«æ‹’ç»ï¼š{{item.rejectReason}}</text>
              </view>
              <view class="task-reward">
                <text class="star-icon">â­</text>
                <text>+{{item.rewardStars}}</text>
                <text class="xp-reward">+{{item.rewardStars}} XP</text>
              </view>
              <view class="task-time-hint">
                <text class="clock-icon">ğŸ•</text>
                <text>{{item.formattedTime}}</text>
              </view>
            </view>
            <view class="task-actions">
              <view class="complete-btn" data-task="{{item}}" catchtap="handleComplete">
  <text class="btn-text">{{isToday ? 'âœ“' : 'â—'}}</text>
</view>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- å®¡æ ¸ä¸­ä»»åŠ¡ -->
    <view class="pending-review-tasks" wx:if="{{reviewingTasks.length > 0}}">
      <text class="subsection-title">â³ å®¡æ ¸ä¸­</text>
      <view class="task-list">
        <view
          wx:for="{{reviewingTasks}}"
          wx:key="id"
          class="task-card reviewing"
        >
          <view class="task-content">
            <view class="task-info">
              <text class="task-title">{{item.title}}</text>
              <view class="task-reward">
                <text class="star-icon">â­</text>
                <text>å¾…å®¡æ ¸ +{{item.rewardStars}}</text>
              </view>
            </view>
            <view class="task-actions">
              <button size="mini" class="review-btn" data-task="{{item}}" bindtap="viewTaskEvidence">æŸ¥çœ‹ç…§ç‰‡</button>
              <view class="reviewing-status">
                <text class="clock-icon">â°</text>
                <text class="reviewing-text">å®¡æ ¸ä¸­</text>
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- å·²å®Œæˆä»»åŠ¡ -->
    <view class="completed-tasks">
      <text class="subsection-title">âœ… å·²å®Œæˆ</text>
      <view wx:if="{{completedTasks.length === 0}}" class="empty-state">
        <text class="empty-emoji">ğŸš©</text>
        <text class="empty-text">è¿˜æ²¡æœ‰å®Œæˆçš„ä»»åŠ¡</text>
      </view>
      <view wx:else class="completed-list">
        <view
          wx:for="{{completedTasks}}"
          wx:key="id"
          class="completed-task-item"
        >
          <text class="success-icon">âœ“</text>
          <text class="task-title">{{item.title}}</text>
          <view class="task-reward">
            <text class="star-icon">â­</text>
            <text>+{{item.rewardStars}}</text>
          </view>
          <button size="mini" type="info" class="view-evidence-btn" data-task="{{item}}" bindtap="viewTaskEvidence">æŸ¥çœ‹ç…§ç‰‡</button>
        </view>
        <view class="today-total">
          <text class="star-icon">â­</text>
          <text>ä»Šæ—¥å¥–åŠ±ï¼š{{todayTotalStars}} æ˜Ÿæ˜Ÿ</text>
        </view>
      </view>
    </view>

    <!-- å»¶æœŸä»»åŠ¡åŒºåŸŸ -->
    <view class="overdue-tasks" wx:if="{{overdueTasks.length > 0 || overdueCount > 0}}">
      <text class="subsection-title overdue-title">âš ï¸ å»¶æœŸä»»åŠ¡ <text class="overdue-count">({{overdueCount}}é¡¹)</text></text>
      <view class="task-list">
        <view
          wx:for="{{overdueTasks}}"
          wx:key="id"
          class="task-card overdue"
        >
          <view class="task-content">
            <view class="task-info">
              <text class="task-title">{{item.title}}</text>
              <view wx:if="{{item.rejectReason}}" class="task-reject-reason">
                <text class="reject-icon">âš ï¸</text>
                <text class="reject-text">ä¸Šæ¬¡è¢«æ‹’ç»ï¼š{{item.rejectReason}}</text>
              </view>
              <view class="task-reward">
                <text class="star-icon">â­</text>
                <text>+{{item.rewardStars}}</text>
              </view>
              <view class="task-time-hint overdue-hint">
                <text class="clock-icon">ğŸ•</text>
                <text>ä»»åŠ¡æ—¶é—´ï¼š{{item.formattedDateTime}}</text>
              </view>
            </view>
            <view class="task-actions">
              <view
                class="complete-btn"
                data-task="{{item}}"
                catchtap="handleComplete"
              >
                <text class="btn-text">{{item.status === 'PENDING' || item.status === 1 ? 'â—Œ' : 'âœ“'}}</text>
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- å¹¸è¿å±‹æ‚¬æµ®æŒ‰é’® -->
  <view class="floating-lucky-btn" bindtap="goToLuckyHouse">
    <text class="lucky-icon">ğŸ</text>
    <text class="lucky-text">å¹¸è¿å±‹</text>
  </view>

  <!-- åº•éƒ¨å¯¼èˆªæ  -->
  <view class="bottom-nav">
    <view class="nav-item active">
      <text class="nav-icon">ğŸ </text>
      <text>é¦–é¡µ</text>
    </view>
    <view class="nav-item" bindtap="goToShop">
      <text class="nav-icon">ğŸª</text>
      <text>å•†åº—</text>
    </view>
    <view class="nav-item" bindtap="goToLuckyHouse">
      <text class="nav-icon">ğŸ°</text>
      <text>å¹¸è¿å±‹</text>
    </view>
  </view>

  <!-- è¯æ®ä¸Šä¼ å¯¹è¯æ¡† -->
  <view class="dialog-mask" wx:if="{{showEvidenceDialog}}" bindtap="closeEvidenceDialog"></view>
  <view class="evidence-dialog" wx:if="{{showEvidenceDialog}}">
    <view class="dialog-header">
      <text class="dialog-title">ä¸Šä¼ å®Œæˆç…§ç‰‡</text>
    </view>
    <view class="dialog-body">
      <view class="task-info">
        <text class="task-info-title">{{selectedTaskForEvidence.title}}</text>
        <text class="task-info-desc">{{selectedTaskForEvidence.description}}</text>
      </view>

      <view wx:if="{{selectedTaskForEvidence.rejectReason}}" class="reject-reason">
        <text class="reject-icon">âš ï¸</text>
        <text>ä¸Šæ¬¡è¢«æ‹’ç»ï¼š{{selectedTaskForEvidence.rejectReason}}</text>
      </view>

      <view class="evidence-section">
        <view wx:if="{{evidencePreviews.length === 0}}" class="upload-options">
          <button class="upload-btn camera-btn" bindtap="takePhoto">ğŸ“· æ‹ç…§</button>
          <button class="upload-btn gallery-btn" bindtap="chooseFromGallery">ğŸ–¼ï¸ ä»ç›¸å†Œé€‰æ‹©</button>
        </view>

        <view wx:else class="preview-section">
          <scroll-view scroll-x="true" class="preview-scroll">
            <view class="preview-grid">
              <view wx:for="{{evidencePreviews}}" wx:key="index" class="preview-item">
                <image src="{{item}}" mode="aspectFill" class="evidence-preview"></image>
              </view>
            </view>
          </scroll-view>
          <view class="preview-actions">
            <button class="preview-btn" bindtap="takePhoto">ğŸ“· é‡æ‹</button>
            <button class="preview-btn" bindtap="chooseFromGallery">ğŸ–¼ï¸ é‡æ–°é€‰æ‹©</button>
          </view>
        </view>
      </view>
    </view>

    <view class="dialog-footer">
      <button class="cancel-btn" bindtap="closeEvidenceDialog">å–æ¶ˆ</button>
      <button class="submit-btn" bindtap="submitWithEvidence" loading="{{uploadingEvidence}}">
        {{uploadingEvidence ? 'æäº¤ä¸­...' : 'æäº¤'}}
      </button>
    </view>
  </view>

  <!-- æŸ¥çœ‹è¯æ®å¯¹è¯æ¡† -->
  <view class="dialog-mask" wx:if="{{showViewEvidenceDialog}}" bindtap="closeViewEvidenceDialog"></view>
  <view class="view-evidence-dialog" wx:if="{{showViewEvidenceDialog}}">
    <view class="dialog-header">
      <text class="dialog-title">ä»»åŠ¡å®Œæˆç»“æœ</text>
    </view>
    <view class="dialog-body">
      <view class="task-info">
        <text class="task-info-title">{{selectedTaskForEvidence.title}}</text>
        <text class="task-info-desc">{{selectedTaskForEvidence.description}}</text>
      </view>

      <view wx:if="{{selectedTaskForEvidence.rejectReason}}" class="reject-reason">
        <text class="reject-icon">âš ï¸</text>
        <text>æ‹’ç»ç†ç”±ï¼š{{selectedTaskForEvidence.rejectReason}}</text>
      </view>

      <view wx:if="{{currentTaskEvidence.length === 0}}" class="no-evidence">
        <text class="no-evidence-icon">ğŸ“·</text>
        <text class="no-evidence-text">æš‚æ— ç»“æœå›¾ç‰‡</text>
      </view>

      <scroll-view wx:else scroll-y="true" class="evidence-scroll">
        <view class="evidence-gallery">
          <view wx:for="{{currentTaskEvidence}}" wx:key="id" class="evidence-item">
            <image
              src="{{apiBaseUrl}}/{{item.imagePath}}"
              mode="aspectFill"
              class="evidence-image"
              data-src="{{apiBaseUrl}}/{{item.imagePath}}"
              bindtap="previewEvidenceImage"
            ></image>
            <view class="evidence-meta">
              <text class="upload-time">{{formatTime(item.uploadTime)}}</text>
            </view>
          </view>
        </view>
      </scroll-view>
    </view>

    <view class="dialog-footer" wx:if="{{isPendingStatus(selectedTaskForEvidence.status)}}">
      <button class="replace-btn" bindtap="replaceEvidence">é‡æ–°ä¸Šä¼ ç…§ç‰‡</button>
    </view>
  </view>

  <!-- ==================== æ¯æ—¥æ‰“å¡å¼¹çª— ==================== -->
  <view class="checkin-mask" wx:if="{{showCheckInDialog}}"></view>
  <view class="checkin-dialog" wx:if="{{showCheckInDialog}}">
    <view class="checkin-content">
      <!-- è¿ç­¾è¿›åº¦ -->
      <view class="streak-bar-section" wx:if="{{streakDays > 0 || checkedIn}}">
        <view class="streak-bar-header">
          <text class="fire-icon">ğŸ”¥</text>
          <text class="streak-bar-label">è¿ç»­æ‰“å¡</text>
          <text class="streak-count">{{streakDays}} å¤©</text>
        </view>
        <view class="streak-bar-track">
          <view class="streak-bar-fill" style="width: {{(streakDays % 7) / 7 * 100}}%"></view>
        </view>
        <view class="streak-bar-labels">
          <text wx:for="{{[1,2,3,4,5,6,7]}}" wx:key="*this" class="streak-day-label {{item <= (streakDays % 7 || 7) ? 'active' : ''}}">{{item}}</text>
        </view>
        <view class="streak-bonus-hint">{{streakBonusMessage}}</view>
      </view>

      <!-- å¿ƒæƒ…é€‰æ‹© -->
      <text class="checkin-title">ä»Šå¤©å¿ƒæƒ…æ€ä¹ˆæ ·ï¼Ÿ</text>
      <view class="mood-selector">
        <view
          wx:for="{{moodsData}}"
          wx:key="type"
          class="mood-item {{selectedMood === item.type ? 'selected' : ''}}"
          data-mood="{{item.type}}"
          bindtap="selectMood"
        >
          <text class="mood-emoji-wrap">{{item.emoji}}</text>
          <text class="mood-label">{{item.label}}</text>
        </view>
      </view>

      <!-- æ‰“å¡ç»“æœé¢„è§ˆ -->
      <view class="checkin-result" wx:if="{{checkInResult}}">
        <text class="result-emoji">{{checkInResult.leveledUp ? 'ğŸ‰' : 'âœ¨'}}</text>
        <view class="result-text">
          <text wx:if="{{checkInResult.leveledUp}}" class="level-up-text">æ­å–œå‡çº§ï¼{{checkInResult.newTitle}}</text>
          <text class="gain-text">è·å¾— {{checkInResult.xpGain}} XP + {{checkInResult.starGain}} æ˜Ÿæ˜Ÿ</text>
        </view>
      </view>
    </view>

    <view class="checkin-footer">
      <button class="checkin-btn" bindtap="{{checkedIn ? 'closeCheckInDialog' : 'confirmCheckIn'}}" loading="{{checkInLoading}}">
        {{checkedIn ? 'æ˜å¤©å†æ¥' : 'æ‰“å¡'}}
      </button>
    </view>
  </view>

  <!-- ==================== å‡çº§å¼¹çª— ==================== -->
  <view class="levelup-mask" wx:if="{{showLevelUpDialog}}" bindtap="closeLevelUpDialog"></view>
  <view class="levelup-dialog" wx:if="{{showLevelUpDialog}}">
    <view class="levelup-content">
      <view class="levelup-badge">
        <text class="levelup-number">{{newLevel}}</text>
        <text class="levelup-label">çº§</text>
      </view>
      <text class="levelup-title">ğŸŠ å‡çº§å•¦ï¼ğŸŠ</text>
      <text class="levelup-newtitle">{{newTitle}}</text>
      <text class="levelup-reward">è§£é”æ–°å¤´åƒæ¡†ï¼</text>
      <button class="levelup-btn" bindtap="closeLevelUpDialog">å¤ªæ£’äº†ï¼</button>
    </view>
  </view>
</view>
